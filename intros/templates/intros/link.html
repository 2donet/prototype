{% extends "base.html" %}
{% load static %}

{% block title %}Link Intro to {{ entity_type }}{% endblock %}

{% block content %}

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <style>
        :root {
            --highlight: #e5c129;
            --text: #ffffff;
            --highlightdark: #3B4139;
            --bg-color: #141622;
            --bg-light: #1d1e2d;
            --bg-color2: #1f2234;
            --bg-color3: #30344a;
            --confirm: #5ce65c;
            --danger: #ff2c2c;
            --warning: #db9200;
            --bg-menu: #222434;
            --information: #305cde;
            --text2ndary: #d1d1d1;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Roboto', sans-serif;
        }
        
        .card {
            background-color: var(--bg-light);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .card-content {
            color: var(--text);
        }
        
        .card-title {
            color: var(--highlight) !important;
            font-weight: 500;
        }
        
        .input-field input:focus + label,
        .input-field textarea:focus + label {
            color: var(--highlight) !important;
        }
        
        .input-field input:focus,
        .input-field textarea:focus {
            border-bottom: 1px solid var(--highlight) !important;
            box-shadow: 0 1px 0 0 var(--highlight) !important;
        }
        
        .input-field input,
        .input-field textarea {
            color: var(--text);
            background-color: var(--bg-color2);
            border-radius: 4px;
            padding: 12px;
            border: 1px solid var(--bg-color3);
        }
        
        .input-field label {
            color: var(--text2ndary);
        }
        
        .input-field label.active {
            color: var(--highlight);
        }
        
        select {
            background-color: var(--bg-color2);
            color: var(--text);
            border: 1px solid var(--bg-color3);
            border-radius: 4px;
            padding: 8px;
        }
        
        .helper-text {
            color: var(--text2ndary);
            font-size: 0.9em;
        }
        
        .btn {
            background-color: var(--highlight);
            color: var(--bg-color);
            border-radius: 8px;
            text-transform: none;
            font-weight: 500;
        }
        
        .btn:hover {
            background-color: var(--highlight-dark);
        }
        
        .btn-secondary {
            background-color: var(--bg-color3);
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background-color: var(--highlightmenu);
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 4px;
        }
        
        .context-info {
            background-color: var(--bg-color2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            border-left: 4px solid var(--information);
        }
        
        .available-intros {
            background-color: var(--bg-color2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            border-left: 4px solid var(--confirm);
        }
        
        .intro-preview {
            background-color: var(--bg-color3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid var(--highlight);
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--highlight);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row" style="margin-top: 32px;">
            <div class="col s12 l8 offset-l2">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">link</i>
                            Link Introduction to {{ entity_type }}
                        </span>
                        
                        <!-- Context Information -->
                        <div class="context-info">
                            <h6><i class="material-icons left">info</i>Linking intro to:</h6>
                            <p style="margin: 8px 0 0 0; font-weight: 500;">{{ related_object }}</p>
                        </div>
                        
                        <!-- Available Intros Info -->
                        <div class="available-intros">
                            <h6><i class="material-icons left">library_books</i>Available Introductions ({{ available_intros.count }})</h6>
                            <p style="margin: 8px 0 0 0; color: var(--text2ndary);">
                                Showing intros from the same project context that can be linked to this {{ entity_type|lower }}.
                            </p>
                            
                            {% if available_intros %}
                                <div style="margin-top: 16px; max-height: 300px; overflow-y: auto;">
                                    {% for intro in available_intros %}
                                        <div class="intro-preview">
                                            <div style="display: flex; justify-content: between; align-items: start;">
                                                <div style="flex: 1;">
                                                    <h6 style="margin: 0; color: var(--highlight);">{{ intro.name }}</h6>
                                                    <p style="margin: 4px 0; font-size: 0.9em;">{{ intro.summary|truncatechars:100 }}</p>
                                                    <small style="color: var(--text2ndary);">
                                                        by {{ intro.by_user.username }} â€¢ {{ intro.get_intro_type_display }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="center-align" style="padding: 20px;">
                                    <i class="material-icons large" style="color: var(--text2ndary);">search_off</i>
                                    <p style="color: var(--text2ndary); margin-top: 16px;">No suitable intros found to link.</p>
                                    <p style="color: var(--text2ndary); font-size: 0.9em;">
                                        Intros must belong to the same project or parent project to be linkable.
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if available_intros %}
                            <form method="post">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <!-- Intro Selection -->
                                    <div class="input-field col s12">
                                        <h6>{{ form.intro.label }}</h6>
                                        {{ form.intro }}
                                        {% if form.intro.help_text %}
                                            <span class="helper-text">{{ form.intro.help_text }}</span>
                                        {% endif %}
                                        {% if form.intro.errors %}
                                            {% for error in form.intro.errors %}
                                                <div class="error-message">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Status and Order -->
                                    <div class="input-field col s12 m6">
                                        <h6>{{ form.status.label }}</h6>
                                        {{ form.status }}
                                        {% if form.status.help_text %}
                                            <span class="helper-text">{{ form.status.help_text }}</span>
                                        {% endif %}
                                        {% if form.status.errors %}
                                            {% for error in form.status.errors %}
                                                <div class="error-message">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    
                                    <div class="input-field col s12 m6">
                                        <h6>{{ form.order.label }}</h6>
                                        {{ form.order }}
                                        {% if form.order.help_text %}
                                            <span class="helper-text">{{ form.order.help_text }}</span>
                                        {% endif %}
                                        {% if form.order.errors %}
                                            {% for error in form.order.errors %}
                                                <div class="error-message">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Note -->
                                    <div class="input-field col s12">
                                        {{ form.note }}
                                        <label for="id_note">{{ form.note.label }}</label>
                                        {% if form.note.help_text %}
                                            <span class="helper-text">{{ form.note.help_text }}</span>
                                        {% endif %}
                                        {% if form.note.errors %}
                                            {% for error in form.note.errors %}
                                                <div class="error-message">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Buttons -->
                                <div class="row">
                                    <div class="col s12 center-align">
                                        <button type="submit" class="btn waves-effect waves-light" style="margin-right: 16px;">
                                            <i class="material-icons left">link</i>Link Introduction
                                        </button>
                                        <a href="javascript:history.back()" class="btn-secondary btn waves-effect waves-light">
                                            <i class="material-icons left">cancel</i>Cancel
                                        </a>
                                    </div>
                                </div>
                            </form>
                        {% else %}
                            <div class="center-align" style="margin-top: 24px;">
                                <a href="{% url 'intros:create' entity_type|lower entity_id %}" class="btn waves-effect waves-light">
                                    <i class="material-icons left">add_circle</i>Create New Introduction Instead
                                </a>
                                <a href="javascript:history.back()" class="btn-secondary btn waves-effect waves-light" style="margin-left: 16px;">
                                    <i class="material-icons left">arrow_back</i>Go Back
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Materialize components
            M.FormSelect.init(document.querySelectorAll('select'));
            M.textareaAutoResize(document.querySelectorAll('textarea'));
            M.updateTextFields();
        });
    </script>
</body>
</html>

<!-- JavaScript for AJAX integration -->
<script>
// Enhanced intro loading with relationship status awareness
function loadIntrosForEntity(entityType, entityId, containerId) {
    const url = `/intros/api/for-${entityType}/${entityId}/`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById(containerId);
            
            if (data.intros.length === 0) {
                container.innerHTML = `
                    <div class="center-align" style="padding: 20px;">
                        <i class="material-icons large" style="color: var(--text2ndary);">description</i>
                        <p style="color: var(--text2ndary); margin-top: 16px;">No introductions yet.</p>
                        ${data.can_link_intros ? `
                            <div style="margin-top: 16px;">
                                <a href="/intros/create/${entityType}/${entityId}/" class="btn waves-effect">
                                    <i class="material-icons left">add</i>Create Introduction
                                </a>
                                <a href="/intros/link/${entityType}/${entityId}/" class="btn-secondary waves-effect" style="margin-left: 8px;">
                                    <i class="material-icons left">link</i>Link Existing
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="row">
                    <div class="col s12">
                        <h5 style="color: var(--highlight);">
                            <i class="material-icons left">description</i>
                            Introductions (${data.count})
                        </h5>
                        ${data.can_link_intros ? `
                            <div style="margin-bottom: 16px;">
                                <a href="/intros/create/${entityType}/${entityId}/" class="btn waves-effect">
                                    <i class="material-icons left">add</i>Create New
                                </a>
                                <a href="/intros/link/${entityType}/${entityId}/" class="btn-secondary waves-effect" style="margin-left: 8px;">
                                    <i class="material-icons left">link</i>Link Existing
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            data.intros.forEach(intro => {
                const statusClass = intro.relation_status_code || 'published';
                const isDraft = intro.relation_status_code !== 'published';
                
                html += `
                    <div class="intro-item card-panel ${statusClass}" style="
                        background-color: var(--bg-color2);
                        border-radius: 8px;
                        margin-bottom: 12px;
                        border-left: 3px solid ${isDraft ? 'var(--warning)' : 'var(--confirm)'};
                        transition: all 0.3s ease;
                        ${isDraft ? 'background-color: rgba(219, 146, 0, 0.1);' : ''}
                    ">
                        <div class="row valign-wrapper">
                            <div class="col s12 m8">
                                <h6>
                                    <a href="${intro.url}" style="color: var(--highlight);">${intro.name}</a>
                                    <span class="status-badge ${statusClass}" style="
                                        display: inline-block;
                                        padding: 4px 12px;
                                        border-radius: 16px;
                                        font-size: 0.8em;
                                        font-weight: 500;
                                        text-transform: uppercase;
                                        margin-left: 8px;
                                        background-color: ${isDraft ? 'var(--warning)' : 'var(--confirm)'};
                                        color: var(--bg-color);
                                    ">
                                        ${intro.relation_status}
                                    </span>
                                </h6>
                                <p style="margin: 8px 0; color: var(--text);">${intro.summary}</p>
                                <div style="margin: 8px 0;">
                                    <small style="color: var(--text2ndary);">
                                        <i class="material-icons tiny">category</i> ${intro.intro_type} |
                                        <i class="material-icons tiny">person</i> by ${intro.by_user} |
                                        <i class="material-icons tiny">access_time</i> ${new Date(intro.created_at).toLocaleDateString()}
                                        ${intro.linked_by ? ` | <i class="material-icons tiny">link</i> linked by ${intro.linked_by}` : ''}
                                    </small>
                                </div>
                                ${intro.status_note ? `<p style="color: var(--warning); font-style: italic;"><i class="material-icons tiny">info</i> ${intro.status_note}</p>` : ''}
                            </div>
                            <div class="col s12 m4 right-align">
                                ${intro.can_edit ? `<a href="${intro.url}edit/" class="btn-secondary btn-small waves-effect"><i class="material-icons left">edit</i>Edit</a>` : ''}
                                ${intro.can_edit_relation ? `<a href="#" onclick="manageRelation(${intro.relation_id})" class="btn-secondary btn-small waves-effect" style="margin-left: 4px;"><i class="material-icons left">settings</i>Manage</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading intros:', error);
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="center-align" style="padding: 20px;">
                    <i class="material-icons large" style="color: var(--danger);">error</i>
                    <p style="color: var(--danger); margin-top: 16px;">Error loading introductions</p>
                </div>
            `;
        });
}

// Function to manage relationship status
function manageRelation(relationId) {
    // In a real implementation, this would open a modal or navigate to management page
    window.location.href = `/intros/relation/${relationId}/status/`;
}

// Convenience functions for each entity type
function loadIntrosForProject(projectId, containerId) {
    loadIntrosForEntity('project', projectId, containerId);
}

function loadIntrosForTask(taskId, containerId) {
    loadIntrosForEntity('task', taskId, containerId);
}

function loadIntrosForNeed(needId, containerId) {
    loadIntrosForEntity('need', needId, containerId);
}

function loadIntrosForProblem(problemId, containerId) {
    loadIntrosForEntity('problem', problemId, containerId);
}

function loadIntrosForPlan(planId, containerId) {
    loadIntrosForEntity('plan', planId, containerId);
}
</script>
{% endblock %}