{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{% if mode == 'edit' %}Edit Need: {{ need.name }}{% else %}Create Need{% if project %} for {{ project.name }}{% endif %}{% endif %} | 2do.net{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col s12">
            <div class="breadcrumb-nav">
                {% if mode == 'edit' and need %}
                    <a href="{% url 'need:need' need.id %}" class="breadcrumb-link">
                        <i class="material-icons left">arrow_back</i>{{ need.name }}
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="current-page">Edit</span>
                {% else %}
                    <a href="{% if project %}{% url 'project:project' project.id %}{% else %}{% url 'need:need_list' %}{% endif %}" class="breadcrumb-link">
                        <i class="material-icons left">arrow_back</i>{% if project %}{{ project.name }}{% else %}All Needs{% endif %}
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="current-page">Create Need</span>
                {% endif %}
            </div>
            
            <h3 class="page-title">
                <i class="material-icons large">{% if mode == 'edit' %}edit{% else %}add_circle{% endif %}</i>
                {% if mode == 'edit' %}Edit Need{% else %}Create New Need{% endif %}
                {% if project and mode == 'create' %}
                    <span class="project-context">for {{ project.name }}</span>
                {% endif %}
            </h3>
        </div>
    </div>

    <!-- Display form errors -->
    {% if form.errors %}
        <div class="row">
            <div class="col s12">
                <div class="card red lighten-4">
                    <div class="card-content">
                        <span class="card-title red-text">Please correct the following errors:</span>
                        {% for field, errors in form.errors.items %}
                            <p><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Main Form -->
    <form method="post" id="need-form">
        {% csrf_token %}
        <div class="row">
            <div class="col s12 l8">
                <!-- Basic Information Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">info</i>Basic Information
                        </span>
                        
                        <div class="row">
                            <div class="input-field col s12">
                                {{ form.name }}
                                <label for="{{ form.name.id_for_label }}" class="{% if form.name.value %}active{% endif %}">Need Name *</label>
                                <span class="helper-text">{{ form.name.help_text|default:"Short, descriptive name for this need" }}</span>
                                {% if form.name.errors %}
                                    <span class="helper-text red-text">{{ form.name.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                {{ form.desc }}
                                <label for="{{ form.desc.id_for_label }}" class="{% if form.desc.value %}active{% endif %}">Description</label>
                                <span class="helper-text">{{ form.desc.help_text|default:"Detailed description of what needs to be done" }}</span>
                                {% if form.desc.errors %}
                                    <span class="helper-text red-text">{{ form.desc.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s6 m4">
                                {{ form.priority }}
                                <label>Priority Level</label>
                                {% if form.priority.errors %}
                                    <span class="helper-text red-text">{{ form.priority.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="input-field col s6 m4">
                                {{ form.status }}
                                <label>Status</label>
                                {% if form.status.errors %}
                                    <span class="helper-text red-text">{{ form.status.errors|join:", " }}</span>
                                {% endif %}
                            </div>

                            <div class="input-field col s12 m4">
                                {{ form.visibility }}
                                <label>Visibility</label>
                                {% if form.visibility.errors %}
                                    <span class="helper-text red-text">{{ form.visibility.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills & Requirements Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">label</i>Skills & Requirements
                        </span>
                        
                        <div class="row">
                            <div class="col s12">
                                <label>Required Skills</label>
                                <div class="chips chips-autocomplete" id="skills-input"></div>
                                <span class="helper-text">Add skills required to fulfill this need. Type and press Enter to add.</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12 m6">
                                {{ form.skill_level }}
                                <label>Required Skill Level</label>
                                {% if form.skill_level.errors %}
                                    <span class="helper-text red-text">{{ form.skill_level.errors|join:", " }}</span>
                                {% endif %}
                            </div>

                            <div class="input-field col s12 m6">
                                {{ form.estimated_time_hours }}
                                <label for="{{ form.estimated_time_hours.id_for_label }}" class="{% if form.estimated_time_hours.value %}active{% endif %}">Estimated Time (hours)</label>
                                <span class="helper-text">{{ form.estimated_time_hours.help_text }}</span>
                                {% if form.estimated_time_hours.errors %}
                                    <span class="helper-text red-text">{{ form.estimated_time_hours.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                {{ form.resources }}
                                <label for="{{ form.resources.id_for_label }}" class="{% if form.resources.value %}active{% endif %}">Required Resources</label>
                                <span class="helper-text">List any tools, materials, or resources needed</span>
                                {% if form.resources.errors %}
                                    <span class="helper-text red-text">{{ form.resources.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline & Cost Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">schedule</i>Timeline & Cost
                        </span>
                        
                        <div class="row">
                            <div class="input-field col s12 m6">
                                {{ form.deadline }}
                                <label for="{{ form.deadline.id_for_label }}" class="{% if form.deadline.value %}active{% endif %}">Deadline</label>
                                <span class="helper-text">When does this need to be completed?</span>
                                {% if form.deadline.errors %}
                                    <span class="helper-text red-text">{{ form.deadline.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="input-field col s12 m6">
                                {{ form.cost_estimate }}
                                <label for="{{ form.cost_estimate.id_for_label }}" class="{% if form.cost_estimate.value %}active{% endif %}">Cost Estimate ($)</label>
                                <span class="helper-text">Estimated cost to fulfill this need</span>
                                {% if form.cost_estimate.errors %}
                                    <span class="helper-text red-text">{{ form.cost_estimate.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Work Type & Dependencies Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">settings</i>Work Type & Dependencies
                        </span>
                        
                        <div class="row">
                            <div class="col s12">
                                <p><strong>Work Type Options:</strong></p>
                                <p>
                                    <label>
                                        {{ form.is_remote }}
                                        <span>Can be done remotely</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        {{ form.is_stationary }}
                                        <span>Requires on-site presence</span>
                                    </label>
                                </p>
                            </div>
                        </div>

                        {% if mode == 'edit' and need and available_needs %}
                        <div class="row">
                            <div class="col s12">
                                <p><strong>Dependencies:</strong></p>
                                <div class="chips chips-placeholder" id="dependencies-input"></div>
                                <span class="helper-text">Select needs that must be completed before this one</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12">
                                <p><strong>Related Needs:</strong></p>
                                <div class="chips chips-placeholder" id="related-needs-input"></div>
                                <span class="helper-text">Select needs that are related but not dependencies</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Additional Information Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">description</i>Additional Information
                        </span>
                        
                        <div class="row">
                            <div class="input-field col s12">
                                {{ form.documentation_url }}
                                <label for="{{ form.documentation_url.id_for_label }}" class="{% if form.documentation_url.value %}active{% endif %}">Documentation URL</label>
                                <span class="helper-text">Link to relevant documentation or resources</span>
                                {% if form.documentation_url.errors %}
                                    <span class="helper-text red-text">{{ form.documentation_url.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>

                        {% if mode == 'edit' %}
                        <div class="row">
                            <div class="input-field col s12">
                                {{ form.completion_notes }}
                                <label for="{{ form.completion_notes.id_for_label }}" class="{% if form.completion_notes.value %}active{% endif %}">Completion Notes</label>
                                <span class="helper-text">Notes about the completion or progress of this need</span>
                                {% if form.completion_notes.errors %}
                                    <span class="helper-text red-text">{{ form.completion_notes.errors|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col s12 l4">
                <!-- Progress Card -->
                <div class="card need-form-sidebar">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">trending_up</i>Progress
                        </span>
                        
                        <div class="progress-display">
                            <div class="progress">
                                <div class="determinate" style="width: {{ form.progress.value|default:0 }}%"></div>
                            </div>
                            <p class="center-align">{{ form.progress.value|default:0 }}% Complete</p>
                        </div>

                        <div class="input-field progress-display">
                            {{ form.progress }}
                            <span class="helper-text">{% if mode == 'create' %}Initial progress (usually 0%){% else %}Current completion progress{% endif %}</span>
                            {% if form.progress.errors %}
                                <span class="helper-text red-text">{{ form.progress.errors|join:", " }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Context Card -->
                <div class="card need-form-sidebar">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">info_outline</i>Context
                        </span>
                        
                        {% if project %}
                        <div class="context-item">
                            <strong>Project:</strong>
                            <div class="chip">
                                <i class="material-icons tiny">folder</i>
                                {{ project.name }}
                            </div>
                        </div>
                        {% elif need and need.to_project %}
                        <div class="context-item">
                            <strong>Project:</strong>
                            <div class="chip">
                                <i class="material-icons tiny">folder</i>
                                {{ need.to_project.name }}
                            </div>
                        </div>
                        {% endif %}

                        {% if mode == 'edit' and need %}
                        <div class="context-item">
                            <strong>Created:</strong>
                            <p class="grey-text">{{ need.created_date|naturaltime }} by {{ need.created_by.username }}</p>
                        </div>

                        {% if need.completed_by %}
                        <div class="context-item">
                            <strong>Completed:</strong>
                            <p class="grey-text">{{ need.completed_date|naturaltime }} by {{ need.completed_by.username }}</p>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="card need-form-sidebar">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">save</i>Actions
                        </span>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn waves-effect waves-light full-width">
                                <i class="material-icons left">save</i>
                                {% if mode == 'edit' %}Update Need{% else %}Create Need{% endif %}
                            </button>
                            
                            <a href="{% if mode == 'edit' and need %}{% url 'need:need' need.id %}{% elif project %}{% url 'project:project' project.id %}{% else %}{% url 'need:need_list' %}{% endif %}" 
                               class="btn-flat waves-effect full-width center-align">
                                <i class="material-icons left">cancel</i>Cancel
                            </a>

                            {% if mode == 'edit' and need %}
                            <a href="{% url 'need:delete_need' need.id %}" 
                               class="btn red waves-effect full-width center-align"
                               onclick="return confirm('Are you sure you want to delete this need?')">
                                <i class="material-icons left">delete</i>Delete Need
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
/* Need Form Styles */
.page-title {
    color: var(--text);
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.page-title .material-icons {
    color: var(--highlight);
}

.project-context {
    color: var(--text2ndary);
    font-size: 0.8em;
}

.need-form-card,
.need-form-sidebar {
    background: var(--bg-light);
    border: 1px solid var(--highlightmenu);
    margin-bottom: 20px;
}

.need-form-card .card-title,
.need-form-sidebar .card-title {
    color: var(--highlight);
    font-size: 1.2em;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.need-form-card .card-title .material-icons,
.need-form-sidebar .card-title .material-icons {
    color: var(--highlight);
}

/* Form inputs */
.input-field input,
.input-field textarea {
    color: var(--text);
    border-bottom: 1px solid var(--highlightmenu);
}

.input-field input:focus,
.input-field textarea:focus {
    border-bottom: 2px solid var(--highlight);
    box-shadow: 0 1px 0 0 var(--highlight);
}

.input-field label {
    color: var(--text2ndary);
}

.input-field label.active {
    color: var(--highlight);
}

.helper-text {
    color: var(--text2ndary);
    font-size: 0.8em;
}

.helper-text.red-text {
    color: var(--danger) !important;
}

/* Chips styling */
.chips {
    border-bottom: 1px solid var(--highlightmenu);
    min-height: 45px;
}

.chips .chip {
    background-color: var(--bg-color2);
    color: var(--text);
    border: 1px solid var(--highlightmenu);
}

.chips .chip .close {
    color: var(--text2ndary);
}

.chips .chip .close:hover {
    color: var(--danger);
}

.chips input {
    color: var(--text) !important;
}

/* Progress display */
.progress-display {
    margin-bottom: 20px;
}

.progress {
    background-color: var(--bg-color2);
}

.progress .determinate {
    background-color: var(--highlight);
}

/* Context items */
.context-item {
    margin-bottom: 15px;
}

.context-item strong {
    color: var(--highlight);
}

.context-item .chip {
    background-color: var(--bg-color2);
    color: var(--text);
    border: 1px solid var(--highlightmenu);
    margin-top: 5px;
}

.context-item .chip .material-icons {
    color: var(--highlight);
}

/* Action buttons */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.full-width {
    width: 100%;
}

/* Breadcrumb navigation */
.breadcrumb-nav {
    margin-bottom: 20px;
    font-size: 14px;
}

.breadcrumb-link {
    color: var(--text2ndary);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.breadcrumb-link:hover {
    color: var(--highlight);
}

.breadcrumb-separator {
    color: var(--highlightmenu);
    margin: 0 10px;
}

.current-page {
    color: var(--highlight);
}

/* Error styling */
.card.red.lighten-4 {
    background-color: #ffebee !important;
    border: 1px solid #ef5350;
}

/* Responsive adjustments */
@media only screen and (max-width: 992px) {
    .need-form-card,
    .need-form-sidebar {
        margin-bottom: 15px;
    }
    
    .action-buttons {
        margin-top: 20px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing components...');
    
    // Initialize Materialize components
    M.FormSelect.init(document.querySelectorAll('select'));
    M.updateTextFields();
    
    // Initialize chips with a small delay to ensure DOM is fully ready
    setTimeout(function() {
        initializeSkillsChips();
        
        {% if mode == 'edit' and need and available_needs %}
        initializeDependencyChips();
        initializeRelatedNeedsChips();
        {% endif %}
    }, 100);
    
    // Also reinitialize chips when navigating back to the page
    window.addEventListener('pageshow', function(event) {
        // Only reinitialize if coming from cache (back/forward navigation)
        if (event.persisted) {
            console.log('Page loaded from cache, reinitializing chips...');
            setTimeout(function() {
                initializeSkillsChips();
                
                {% if mode == 'edit' and need and available_needs %}
                initializeDependencyChips();
                initializeRelatedNeedsChips();
                {% endif %}
            }, 100);
        }
    });
});

function initializeSkillsChips() {
    const skillsElement = document.getElementById('skills-input');
    
    // Check if element exists and hasn't been initialized already
    if (!skillsElement) {
        console.warn('Skills input element not found');
        return;
    }
    
    // Prevent double initialization
    const existingInstance = M.Chips.getInstance(skillsElement);
    if (existingInstance) {
        console.log('Skills chips already initialized, destroying first');
        existingInstance.destroy();
    }
    
    // Get existing skills from template
    const existingSkills = [
        {% if need and need.required_skills.all %}
            {% for skill in need.required_skills.all %}
                {tag: '{{ skill.name }}'},
            {% endfor %}
        {% endif %}
    ];
    
    console.log('Initializing skills chips with existing skills:', existingSkills);
    
    // Fetch skills for autocomplete
    fetch('/n/api/skills/autocomplete/')
        .then(response => response.json())
        .then(data => {
            const autocompleteData = {};
            if (data.success && data.skills) {
                data.skills.forEach(skill => {
                    autocompleteData[skill.name] = null;
                });
            }

            // Initialize chips with autocomplete
            const chipsInstance = M.Chips.init(skillsElement, {
                data: existingSkills,
                placeholder: 'Add skills...',
                secondaryPlaceholder: 'Enter skill name',
                autocompleteOptions: {
                    data: autocompleteData,
                    limit: 10,
                    minLength: 1
                }
            });
            
            console.log('Skills chips initialized successfully with autocomplete');
        })
        .catch(error => {
            console.warn('Could not load skills autocomplete, initializing without:', error);
            
            // Initialize without autocomplete as fallback
            const chipsInstance = M.Chips.init(skillsElement, {
                data: existingSkills,
                placeholder: 'Add skills...',
                secondaryPlaceholder: 'Enter skill name'
            });
            
            console.log('Skills chips initialized successfully without autocomplete');
        });
}

{% if mode == 'edit' and need and available_needs %}
function initializeDependencyChips() {
    const dependenciesElement = document.getElementById('dependencies-input');
    
    if (!dependenciesElement) {
        console.warn('Dependencies input element not found');
        return;
    }
    
    // Prevent double initialization
    const existingInstance = M.Chips.getInstance(dependenciesElement);
    if (existingInstance) {
        console.log('Dependencies chips already initialized, destroying first');
        existingInstance.destroy();
    }
    
    const dependencyData = {};
    {% for need_dep in available_needs %}
        dependencyData['{{ need_dep.name }}'] = null;
    {% endfor %}

    const existingDependencies = [
        {% if need and need.depends_on.all %}
            {% for dep in need.depends_on.all %}
                {tag: '{{ dep.name }}'},
            {% endfor %}
        {% endif %}
    ];
    
    console.log('Initializing dependency chips with existing dependencies:', existingDependencies);

    M.Chips.init(dependenciesElement, {
        data: existingDependencies,
        placeholder: 'Add dependencies...',
        secondaryPlaceholder: 'Enter need name',
        autocompleteOptions: {
            data: dependencyData,
            limit: 10,
            minLength: 1
        }
    });
}

function initializeRelatedNeedsChips() {
    const relatedElement = document.getElementById('related-needs-input');
    
    if (!relatedElement) {
        console.warn('Related needs input element not found');
        return;
    }
    
    // Prevent double initialization
    const existingInstance = M.Chips.getInstance(relatedElement);
    if (existingInstance) {
        console.log('Related needs chips already initialized, destroying first');
        existingInstance.destroy();
    }
    
    const relatedData = {};
    {% for need_rel in available_needs %}
        relatedData['{{ need_rel.name }}'] = null;
    {% endfor %}

    const existingRelated = [
        {% if need and need.related_needs.all %}
            {% for related in need.related_needs.all %}
                {tag: '{{ related.name }}'},
            {% endfor %}
        {% endif %}
    ];
    
    console.log('Initializing related needs chips with existing related:', existingRelated);

    M.Chips.init(relatedElement, {
        data: existingRelated,
        placeholder: 'Add related needs...',
        secondaryPlaceholder: 'Enter need name',
        autocompleteOptions: {
            data: relatedData,
            limit: 10,
            minLength: 1
        }
    });
}
{% endif %}

function updateProgressDisplay(value) {
    const progressBar = document.querySelector('.progress .determinate');
    const progressText = document.querySelector('.progress-display p');
    
    if (progressBar) {
        progressBar.style.width = value + '%';
    }
    if (progressText) {
        progressText.textContent = value + '% Complete';
    }
}

// Update progress display when range input changes
const progressInput = document.getElementById('{{ form.progress.id_for_label }}');
if (progressInput) {
    progressInput.addEventListener('input', function(e) {
        updateProgressDisplay(e.target.value);
    });
}

// Handle form submission
document.getElementById('need-form').addEventListener('submit', function(e) {
    // Get skills data
    const skillsElement = document.getElementById('skills-input');
    const skillsInstance = M.Chips.getInstance(skillsElement);
    
    let skillsData = [];
    if (skillsInstance && skillsInstance.chipsData) {
        skillsData = skillsInstance.chipsData.map(chip => chip.tag);
        console.log('Submitting with skills:', skillsData);
    } else {
        console.warn('Skills chips instance not found or has no data');
    }
    
    // Add hidden inputs for skills
    skillsData.forEach(skill => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'required_skills[]';
        input.value = skill;
        this.appendChild(input);
    });

    {% if mode == 'edit' and need and available_needs %}
    // Get dependencies data
    const depsElement = document.getElementById('dependencies-input');
    const depsInstance = M.Chips.getInstance(depsElement);
    if (depsInstance && depsInstance.chipsData) {
        const depsData = depsInstance.chipsData.map(chip => chip.tag);
        console.log('Submitting with dependencies:', depsData);
        depsData.forEach(dep => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'depends_on[]';
            input.value = dep;
            this.appendChild(input);
        });
    }

    // Get related needs data
    const relatedElement = document.getElementById('related-needs-input');
    const relatedInstance = M.Chips.getInstance(relatedElement);
    if (relatedInstance && relatedInstance.chipsData) {
        const relatedData = relatedInstance.chipsData.map(chip => chip.tag);
        console.log('Submitting with related needs:', relatedData);
        relatedData.forEach(related => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'related_needs[]';
            input.value = related;
            this.appendChild(input);
        });
    }
    {% endif %}
});
</script>
{% endblock %}