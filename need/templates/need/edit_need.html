{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{% if mode == 'edit' %}Edit Need: {{ need.name }}{% else %}Create Need{% if project %} for {{ project.name }}{% endif %}{% endif %} | 2do.net{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col s12">
            <div class="breadcrumb-nav">
                {% if mode == 'edit' %}
                    <a href="{% url 'need:need' need.id %}" class="breadcrumb-link">
                        <i class="material-icons left">arrow_back</i>{{ need.name }}
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="current-page">Edit</span>
                {% else %}
                    <a href="{% if project %}{% url 'project:project' project.id %}{% else %}{% url 'need:need_list' %}{% endif %}" class="breadcrumb-link">
                        <i class="material-icons left">arrow_back</i>{% if project %}{{ project.name }}{% else %}All Needs{% endif %}
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="current-page">Create Need</span>
                {% endif %}
            </div>
            
            <h3 class="page-title">
                <i class="material-icons large">{% if mode == 'edit' %}edit{% else %}add_circle{% endif %}</i>
                {% if mode == 'edit' %}Edit Need{% else %}Create New Need{% endif %}
                {% if project and mode == 'create' %}
                    <span class="project-context">for {{ project.name }}</span>
                {% endif %}
            </h3>
        </div>
    </div>

    <!-- Main Form -->
    <form method="post" id="need-form">
        {% csrf_token %}
        <div class="row">
            <div class="col s12 l8">
                <!-- Basic Information Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">info</i>Basic Information
                        </span>
                        
                        <div class="row">
                            <div class="input-field col s12">
                                <input id="name" name="name" type="text" value="{{ need.name|default:'' }}" required maxlength="50">
                                <label for="name" class="{% if need.name %}active{% endif %}">Need Name *</label>
                                <span class="helper-text">Short, descriptive name for this need</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="desc" name="desc" class="materialize-textarea">{{ need.desc|default:'' }}</textarea>
                                <label for="desc" class="{% if need.desc %}active{% endif %}">Description</label>
                                <span class="helper-text">Detailed description of what needs to be done</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s6 m4">
                                <select name="priority" id="priority">
                                    <option value="0" {% if need.priority == 0 %}selected{% endif %}>Minimal (0-24)</option>
                                    <option value="25" {% if need.priority == 25 %}selected{% endif %}>Low (25-49)</option>
                                    <option value="50" {% if need.priority == 50 %}selected{% endif %}>Medium (50-74)</option>
                                    <option value="75" {% if need.priority == 75 %}selected{% endif %}>High (75-100)</option>
                                </select>
                                <label>Priority Level</label>
                            </div>
                            
                            <div class="input-field col s6 m4">
                                <select name="status" id="status">
                                    <option value="pending" {% if need.status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="in_progress" {% if need.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                    <option value="fulfilled" {% if need.status == 'fulfilled' %}selected{% endif %}>Fulfilled</option>
                                    <option value="canceled" {% if need.status == 'canceled' %}selected{% endif %}>Canceled</option>
                                </select>
                                <label>Status</label>
                            </div>

                            <div class="input-field col s12 m4">
                                <select name="visibility" id="visibility">
                                    <option value="public" {% if need.visibility == 'public' %}selected{% endif %}>Public</option>
                                    <option value="members" {% if need.visibility == 'members' %}selected{% endif %}>Project Members Only</option>
                                    <option value="admins" {% if need.visibility == 'admins' %}selected{% endif %}>Admins Only</option>
                                </select>
                                <label>Visibility</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills & Requirements Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">label</i>Skills & Requirements
                        </span>
                        
                        <div class="row">
                            <div class="col s12">
                                <label>Required Skills</label>
                                <div class="chips chips-autocomplete" id="skills-input"></div>
                                <span class="helper-text">Add skills required to fulfill this need. Type and press Enter to add.</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12 m6">
                                <select name="skill_level" id="skill_level">
                                    <option value="" {% if not need.skill_level %}selected{% endif %}>Not Specified</option>
                                    <option value="beginner" {% if need.skill_level == 'beginner' %}selected{% endif %}>Beginner</option>
                                    <option value="intermediate" {% if need.skill_level == 'intermediate' %}selected{% endif %}>Intermediate</option>
                                    <option value="advanced" {% if need.skill_level == 'advanced' %}selected{% endif %}>Advanced</option>
                                    <option value="expert" {% if need.skill_level == 'expert' %}selected{% endif %}>Expert</option>
                                </select>
                                <label>Required Skill Level</label>
                            </div>

                            <div class="input-field col s12 m6">
                                <input id="estimated_time_hours" name="estimated_time_hours" type="number" min="0" step="0.5" value="">
                                <label for="estimated_time_hours">Estimated Time (hours)</label>
                                <span class="helper-text">How long do you estimate this will take?</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="resources" name="resources" class="materialize-textarea">{{ need.resources|default:'' }}</textarea>
                                <label for="resources" class="{% if need.resources %}active{% endif %}">Required Resources</label>
                                <span class="helper-text">List any tools, materials, or resources needed</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline & Cost Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">schedule</i>Timeline & Cost
                        </span>
                        
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <input id="deadline" name="deadline" type="datetime-local" 
                                       value="{% if need.deadline %}{{ need.deadline|date:'Y-m-d\TH:i' }}{% endif %}">
                                <label for="deadline" class="{% if need.deadline %}active{% endif %}">Deadline</label>
                                <span class="helper-text">When does this need to be completed?</span>
                            </div>
                            
                            <div class="input-field col s12 m6">
                                <input id="cost_estimate" name="cost_estimate" type="number" step="0.01" min="0" 
                                       value="{{ need.cost_estimate|default:'' }}">
                                <label for="cost_estimate" class="{% if need.cost_estimate %}active{% endif %}">Cost Estimate ($)</label>
                                <span class="helper-text">Estimated cost to fulfill this need</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Work Type & Dependencies Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">settings</i>Work Type & Dependencies
                        </span>
                        
                        <div class="row">
                            <div class="col s12">
                                <p><strong>Work Type Options:</strong></p>
                                <p>
                                    <label>
                                        <input type="checkbox" name="is_remote" {% if need.is_remote %}checked{% endif %}>
                                        <span>Can be done remotely</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input type="checkbox" name="is_stationary" {% if need.is_stationary %}checked{% endif %}>
                                        <span>Requires on-site presence</span>
                                    </label>
                                </p>
                            </div>
                        </div>

                        {% if mode == 'edit' and available_needs %}
                        <div class="row">
                            <div class="col s12">
                                <p><strong>Dependencies:</strong></p>
                                <div class="chips chips-placeholder" id="dependencies-input"></div>
                                <span class="helper-text">Select needs that must be completed before this one</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12">
                                <p><strong>Related Needs:</strong></p>
                                <div class="chips chips-placeholder" id="related-needs-input"></div>
                                <span class="helper-text">Select needs that are related but not dependencies</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Additional Information Card -->
                <div class="card need-form-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">description</i>Additional Information
                        </span>
                        
                        <div class="row">
                            <div class="input-field col s12">
                                <input id="documentation_url" name="documentation_url" type="url" 
                                       value="{{ need.documentation_url|default:'' }}">
                                <label for="documentation_url" class="{% if need.documentation_url %}active{% endif %}">Documentation URL</label>
                                <span class="helper-text">Link to relevant documentation or resources</span>
                            </div>
                        </div>

                        {% if mode == 'edit' %}
                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="completion_notes" name="completion_notes" class="materialize-textarea">{{ need.completion_notes|default:'' }}</textarea>
                                <label for="completion_notes" class="{% if need.completion_notes %}active{% endif %}">Completion Notes</label>
                                <span class="helper-text">Notes about the completion or progress of this need</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col s12 l4">
                <!-- Progress Card (Edit Mode Only) -->
                {% if mode == 'edit' %}
                <div class="card need-form-sidebar">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">trending_up</i>Progress
                        </span>
                        
                        <div class="progress-display">
                            <div class="progress">
                                <div class="determinate" style="width: {{ need.progress }}%"></div>
                            </div>
                            <p class="center-align">{{ need.progress }}% Complete</p>
                        </div>

                        <div class="input-field">
                            <input id="progress" name="progress" type="range" min="0" max="100" 
                                   value="{{ need.progress }}" oninput="updateProgressDisplay(this.value)">
                            <label for="progress">Progress (%)</label>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Context Card -->
                <div class="card need-form-sidebar">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">info_outline</i>Context
                        </span>
                        
                        {% if project or need.to_project %}
                        <div class="context-item">
                            <strong>Project:</strong>
                            <div class="chip">
                                <i class="material-icons tiny">folder</i>
                                {{ project.name|default:need.to_project.name }}
                            </div>
                        </div>
                        {% endif %}

                        {% if mode == 'edit' %}
                        <div class="context-item">
                            <strong>Created:</strong>
                            <p class="grey-text">{{ need.created_date|naturaltime }} by {{ need.created_by.username }}</p>
                        </div>

                        {% if need.completed_by %}
                        <div class="context-item">
                            <strong>Completed:</strong>
                            <p class="grey-text">{{ need.completed_date|naturaltime }} by {{ need.completed_by.username }}</p>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="card need-form-sidebar">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">save</i>Actions
                        </span>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn waves-effect waves-light full-width">
                                <i class="material-icons left">save</i>
                                {% if mode == 'edit' %}Update Need{% else %}Create Need{% endif %}
                            </button>
                            
                            <a href="{% if mode == 'edit' %}{% url 'need:need' need.id %}{% elif project %}{% url 'project:project' project.id %}{% else %}{% url 'need:need_list' %}{% endif %}" 
                               class="btn-flat waves-effect full-width center-align">
                                <i class="material-icons left">cancel</i>Cancel
                            </a>

                            {% if mode == 'edit' %}
                            <a href="{% url 'need:delete_need' need.id %}" 
                               class="btn red waves-effect full-width center-align"
                               onclick="return confirm('Are you sure you want to delete this need?')">
                                <i class="material-icons left">delete</i>Delete Need
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
/* Need Form Styles */
.page-title {
    color: var(--text);
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.page-title .material-icons {
    color: var(--highlight);
}

.project-context {
    color: var(--text2ndary);
    font-size: 0.8em;
}

.need-form-card,
.need-form-sidebar {
    background: var(--bg-light);
    border: 1px solid var(--highlightmenu);
    margin-bottom: 20px;
}

.need-form-card .card-title,
.need-form-sidebar .card-title {
    color: var(--highlight);
    font-size: 1.2em;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.need-form-card .card-title .material-icons,
.need-form-sidebar .card-title .material-icons {
    color: var(--highlight);
}

/* Form inputs */
.input-field input,
.input-field textarea {
    color: var(--text);
    border-bottom: 1px solid var(--highlightmenu);
}

.input-field input:focus,
.input-field textarea:focus {
    border-bottom: 2px solid var(--highlight);
    box-shadow: 0 1px 0 0 var(--highlight);
}

.input-field label {
    color: var(--text2ndary);
}

.input-field label.active {
    color: var(--highlight);
}

.helper-text {
    color: var(--text2ndary);
    font-size: 0.8em;
}

/* Chips styling */
.chips {
    border-bottom: 1px solid var(--highlightmenu);
    min-height: 45px;
}

.chips .chip {
    background-color: var(--bg-color2);
    color: var(--text);
    border: 1px solid var(--highlightmenu);
}

.chips .chip .close {
    color: var(--text2ndary);
}

.chips .chip .close:hover {
    color: var(--danger);
}

.chips input {
    color: var(--text) !important;
}

/* Progress display */
.progress-display {
    margin-bottom: 20px;
}

.progress {
    background-color: var(--bg-color2);
}

.progress .determinate {
    background-color: var(--highlight);
}

/* Context items */
.context-item {
    margin-bottom: 15px;
}

.context-item strong {
    color: var(--highlight);
}

.context-item .chip {
    background-color: var(--bg-color2);
    color: var(--text);
    border: 1px solid var(--highlightmenu);
    margin-top: 5px;
}

.context-item .chip .material-icons {
    color: var(--highlight);
}

/* Action buttons */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.full-width {
    width: 100%;
}

/* Breadcrumb navigation */
.breadcrumb-nav {
    margin-bottom: 20px;
    font-size: 14px;
}

.breadcrumb-link {
    color: var(--text2ndary);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.breadcrumb-link:hover {
    color: var(--highlight);
}

.breadcrumb-separator {
    color: var(--highlightmenu);
    margin: 0 10px;
}

.current-page {
    color: var(--highlight);
}

/* Responsive adjustments */
@media only screen and (max-width: 992px) {
    .need-form-card,
    .need-form-sidebar {
        margin-bottom: 15px;
    }
    
    .action-buttons {
        margin-top: 20px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Materialize components
    M.FormSelect.init(document.querySelectorAll('select'));
    M.updateTextFields();
    
    // Set estimated time hours value if editing
    {% if mode == 'edit' and need.estimated_time %}
    const estimatedTimeInput = document.getElementById('estimated_time_hours');
    if (estimatedTimeInput) {
        const totalSeconds = {{ need.estimated_time.total_seconds }};
        const hours = Math.round((totalSeconds / 3600) * 10) / 10; // Round to 1 decimal
        estimatedTimeInput.value = hours;
        // Update label state
        const label = estimatedTimeInput.nextElementSibling;
        if (label && label.tagName === 'LABEL') {
            label.classList.add('active');
        }
    }
    {% endif %}
    
    // Initialize skills chips with autocomplete
    initializeSkillsChips();
    
    // Initialize dependency chips (edit mode only)
    {% if mode == 'edit' and available_needs %}
    initializeDependencyChips();
    initializeRelatedNeedsChips();
    {% endif %}
});

function initializeSkillsChips() {
    // Fetch skills for autocomplete
    fetch('/n/api/skills/autocomplete/')
        .then(response => response.json())
        .then(data => {
            const autocompleteData = {};
            if (data.success && data.skills) {
                data.skills.forEach(skill => {
                    autocompleteData[skill.name] = null;
                });
            }

            // Initialize chips with existing skills
            const existingSkills = [
                {% if need.required_skills.all %}
                    {% for skill in need.required_skills.all %}
                        {tag: '{{ skill.name }}'},
                    {% endfor %}
                {% endif %}
            ];

            const skillsElement = document.getElementById('skills-input');
            M.Chips.init(skillsElement, {
                data: existingSkills,
                placeholder: 'Add skills...',
                secondaryPlaceholder: 'Enter skill name',
                autocompleteOptions: {
                    data: autocompleteData,
                    limit: 10,
                    minLength: 1
                }
            });
        })
        .catch(error => {
            console.warn('Could not load skills autocomplete:', error);
            // Initialize without autocomplete
            const existingSkills = [
                {% if need.required_skills.all %}
                    {% for skill in need.required_skills.all %}
                        {tag: '{{ skill.name }}'},
                    {% endfor %}
                {% endif %}
            ];

            const skillsElement = document.getElementById('skills-input');
            M.Chips.init(skillsElement, {
                data: existingSkills,
                placeholder: 'Add skills...',
                secondaryPlaceholder: 'Enter skill name'
            });
        });
}

{% if mode == 'edit' and available_needs %}
function initializeDependencyChips() {
    const dependencyData = {};
    {% for need_dep in available_needs %}
        dependencyData['{{ need_dep.name }}'] = null;
    {% endfor %}

    const existingDependencies = [
        {% for dep in need.depends_on.all %}
            {tag: '{{ dep.name }}'},
        {% endfor %}
    ];

    const dependenciesElement = document.getElementById('dependencies-input');
    M.Chips.init(dependenciesElement, {
        data: existingDependencies,
        placeholder: 'Add dependencies...',
        secondaryPlaceholder: 'Enter need name',
        autocompleteOptions: {
            data: dependencyData,
            limit: 10,
            minLength: 1
        }
    });
}

function initializeRelatedNeedsChips() {
    const relatedData = {};
    {% for need_rel in available_needs %}
        relatedData['{{ need_rel.name }}'] = null;
    {% endfor %}

    const existingRelated = [
        {% for related in need.related_needs.all %}
            {tag: '{{ related.name }}'},
        {% endfor %}
    ];

    const relatedElement = document.getElementById('related-needs-input');
    M.Chips.init(relatedElement, {
        data: existingRelated,
        placeholder: 'Add related needs...',
        secondaryPlaceholder: 'Enter need name',
        autocompleteOptions: {
            data: relatedData,
            limit: 10,
            minLength: 1
        }
    });
}
{% endif %}

function updateProgressDisplay(value) {
    const progressBar = document.querySelector('.progress .determinate');
    const progressText = document.querySelector('.progress-display p');
    
    if (progressBar) {
        progressBar.style.width = value + '%';
    }
    if (progressText) {
        progressText.textContent = value + '% Complete';
    }
}

// Handle form submission
document.getElementById('need-form').addEventListener('submit', function(e) {
    // Get skills data
    const skillsInstance = M.Chips.getInstance(document.getElementById('skills-input'));
    const skillsData = skillsInstance.chipsData.map(chip => chip.tag);
    
    // Add hidden inputs for skills
    skillsData.forEach(skill => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'required_skills[]';
        input.value = skill;
        this.appendChild(input);
    });

    {% if mode == 'edit' and available_needs %}
    // Get dependencies data
    const depsInstance = M.Chips.getInstance(document.getElementById('dependencies-input'));
    if (depsInstance) {
        const depsData = depsInstance.chipsData.map(chip => chip.tag);
        depsData.forEach(dep => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'depends_on[]';
            input.value = dep;
            this.appendChild(input);
        });
    }

    // Get related needs data
    const relatedInstance = M.Chips.getInstance(document.getElementById('related-needs-input'));
    if (relatedInstance) {
        const relatedData = relatedInstance.chipsData.map(chip => chip.tag);
        relatedData.forEach(related => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'related_needs[]';
            input.value = related;
            this.appendChild(input);
        });
    }
    {% endif %}
});
</script>
{% endblock %}