<!-- problems/templates/problems/create_problem.html -->
{% extends "base.html" %}
{% load static %}
{% load comment_tags %}

{% block title %}Report New Problem | 2do.net{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row">
        <div class="col s12">
            <h4>Report a New Problem</h4>
            <p class="grey-text">
                Report a problem for 
                <strong>
                {% if parent_obj.to_project %}{{ parent_obj.to_project.name }} &raquo; {% endif %}
                {{ parent_obj.name }}
                </strong>
            </p>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Problem Details</span>
                    
                    <form method="post" id="create-problem-form">
                        {% csrf_token %}
                        
                        <!-- Problem Name -->
                        <div class="input-field">
                            <input type="text" name="name" id="problem-name" class="validate" 
                                   value="{{ form_data.name|default:'' }}" required maxlength="200">
                            <label for="problem-name">Problem Title *</label>
                            <span class="helper-text">A clear, descriptive title for the problem</span>
                        </div>
                        
                        <!-- Summary -->
                        <div class="input-field">
                            <textarea name="summary" id="problem-summary" class="materialize-textarea" 
                                      maxlength="500">{{ form_data.summary|default:'' }}</textarea>
                            <label for="problem-summary">Brief Summary</label>
                            <span class="helper-text">A one-sentence summary of the problem (optional)</span>
                        </div>
                        
                        <!-- Description -->
                        <div class="input-field">
                            <textarea name="desc" id="problem-desc" class="materialize-textarea" 
                                      required>{{ form_data.desc|default:'' }}</textarea>
                            <label for="problem-desc">Detailed Description *</label>
                            <span class="helper-text">
                                Provide detailed information: steps to reproduce, expected vs actual behavior, 
                                error messages, impact, etc.
                            </span>
                        </div>
                        
                        <!-- Priority and Status Row -->
                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <h6>Priority</h6>
                                    <select class="browser-default" name="priority" id="problem-priority">
                                        {% for value, label in priority_choices %}
                                        <option value="{{ value }}" {% if form_data.priority == value|stringformat:"s" or value == 2 and not form_data.priority %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <span class="helper-text">How urgent is this problem?</span>
                                </div>
                            </div>
                            
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <h6>Status</h6>
                                    <select class="browser-default" name="status" id="problem-status">
                                        {% for value, label in status_choices %}
                                        <option value="{{ value }}" {% if form_data.status == value or value == 'open' and not form_data.status %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <span class="helper-text">Current status of the problem</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Visibility -->
                        <div class="input-field">
                            <h6>Visibility</h6>
                            <select class="browser-default" name="visibility" id="problem-visibility">
                                {% for value, label in visibility_choices %}
                                <option value="{{ value }}" {% if form_data.visibility == value or value == 'public' and not form_data.visibility %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                            <span class="helper-text">Who can view this problem?</span>
                        </div>
                        
                        <!-- Skills -->
                        <div class="input-field">
                            <input type="text" name="skills" id="problem-skills" class="chips-autocomplete"
                                   placeholder="Type skills and press Enter">
                            <label for="problem-skills">Related Skills</label>
                            <span class="helper-text">Skills related to solving this problem</span>
                        </div>
                        
                        <!-- Assignment Section -->
                        <div class="section">
                            <h6>Assignment</h6>
                            <p class="grey-text">Click on project members to assign them to this problem</p>
                            
                            <div id="project-members-container">
                                <div id="project-members-loading" class="center-align">
                                    <div class="preloader-wrapper small active">
                                        <div class="spinner-layer spinner-blue">
                                            <div class="circle-clipper left">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="gap-patch">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="circle-clipper right">
                                                <div class="circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <p>Loading project members...</p>
                                </div>
                                <div id="project-members-list" style="display: none;"></div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Form Actions -->
                <div class="card-action">
                    <button type="submit" form="create-problem-form" class="btn blue waves-effect waves-light">
                        <i class="material-icons left">bug_report</i>Report Problem
                    </button>
                    
                    <a href="{% if parent_obj.to_project %}/{{ parent_obj.to_project.id }}{% elif parent_obj.to_project %}{% url 'project:project' parent_obj.to_project.id %}{% else %}/{% endif %}" 
                       class="btn-flat waves-effect waves-light">
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Materialize components
    M.FormSelect.init(document.querySelectorAll('select'));
    M.textareaAutoResize(document.querySelectorAll('.materialize-textarea'));
    M.CharacterCounter.init(document.querySelectorAll('input[maxlength], textarea[maxlength]'));
    
    // Skills chips
    let skillsData = [];
    const skillsChips = M.Chips.init(document.querySelector('.chips-autocomplete'), {
        placeholder: 'Add a skill',
        secondaryPlaceholder: 'Add another skill',
        onChipAdd: function(e, chip) {
            skillsData = this.chipsData;
        },
        onChipDelete: function(e, chip) {
            skillsData = this.chipsData;
        }
    });
    
    // Assignment functionality
    let assignedUsers = new Set();
    let projectMembers = [];
    
    // Load project members on page load
    loadProjectMembers();
    
    function loadProjectMembers() {
        const projectId = {{ parent_obj.to_project.id|default:parent_obj.id|default:'null' }};
        if (!projectId) {
            document.getElementById('project-members-loading').innerHTML = '<p class="grey-text">No project context available</p>';
            return;
        }
        
        fetch(`/api/problems/users/project-members/?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                projectMembers = data.results;
                displayProjectMembers();
            } else {
                document.getElementById('project-members-loading').innerHTML = '<p class="grey-text">No project members found</p>';
            }
        })
        .catch(error => {
            console.error('Error loading project members:', error);
            document.getElementById('project-members-loading').innerHTML = '<p class="red-text">Error loading project members</p>';
        });
    }
    
    function displayProjectMembers() {
        const container = document.getElementById('project-members-list');
        const loading = document.getElementById('project-members-loading');
        
        if (projectMembers.length === 0) {
            loading.innerHTML = '<p class="grey-text">No project members found</p>';
            return;
        }
        
        container.innerHTML = projectMembers.map(member => `
            <div class="member-chip" data-user-id="${member.id}" onclick="toggleAssignment(${member.id})">
                <img src="${member.avatar_url}" alt="${member.username}" class="member-avatar">
                <span class="member-name">${member.full_name}</span>
            </div>
        `).join('');
        
        loading.style.display = 'none';
        container.style.display = 'block';
    }
    
    window.toggleAssignment = function(userId) {
        const chip = document.querySelector(`.member-chip[data-user-id="${userId}"]`);
        
        if (assignedUsers.has(userId)) {
            // Unassign
            assignedUsers.delete(userId);
            chip.classList.remove('assigned');
        } else {
            // Assign
            assignedUsers.add(userId);
            chip.classList.add('assigned');
        }
    };
    
    // Form submission
    document.getElementById('create-problem-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Add skills data
        const skillNames = skillsData.map(chip => chip.tag);
        skillNames.forEach(skill => {
            formData.append('skills[]', skill);
        });
        
        // Add assigned users
        assignedUsers.forEach(userId => {
            formData.append('assigned_to', userId);
        });
        
        // Submit form
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Creating...';
        submitBtn.disabled = true;
        
        fetch(this.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(html => {
            if (html) {
                // If we got HTML back, there were form errors
                document.body.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            M.toast({html: 'Error creating problem', classes: 'red'});
        })
        .finally(() => {
            submitBtn.innerHTML = '<i class="material-icons left">bug_report</i>Report Problem';
            submitBtn.disabled = false;
        });
    });
});
</script>

<style>
/* Color scheme application */
.chips .chip {
    background-color: var(--bg-color2);
    color: var(--text);
    border: 1px solid var(--highlightmenu);
}

.chips .chip .close {
    color: var(--text2ndary);
}

.chips .chip .close:hover {
    color: var(--danger);
}

.chips input {
    color: var(--text) !important;
}

.helper-text {
    color: var(--text2ndary) !important;
}

/* Member chip styling */
#project-members-list {
    margin-top: 15px;
}

.member-chip {
    display: inline-flex;
    align-items: center;
    padding: 8px 12px;
    margin: 4px;
    background-color: var(--bg-color2);
    border: 2px solid var(--highlightmenu);
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text);
}

.member-chip:hover {
    background-color: var(--bg-color3);
    border-color: var(--highlight);
}

.member-chip.assigned {
    background-color: var(--confirm);
    border-color: var(--confirm);
    color: var(--bg-color);
}

.member-chip.assigned:hover {
    background-color: var(--confirm);
    opacity: 0.9;
}

.member-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
}

.member-name {
    font-size: 0.9rem;
    font-weight: 500;
}

/* Loading spinner */
.spinner-layer.spinner-blue {
    border-color: var(--information);
}

/* Card styling */
.card {
    background-color: var(--bg-color2);
    color: var(--text);
}

.card-title {
    color: var(--text) !important;
}

/* Form styling */
.input-field input:focus + label,
.input-field textarea:focus + label {
    color: var(--highlight) !important;
}

.input-field input:focus,
.input-field textarea:focus {
    border-bottom: 1px solid var(--highlight) !important;
    box-shadow: 0 1px 0 0 var(--highlight) !important;
}

select.browser-default:focus {
    outline-color: var(--highlight);
}

/* Button styling */
.btn {
    background-color: var(--information);
}

.btn:hover {
    background-color: var(--highlight);
    color: var(--bg-color);
}

.btn-flat {
    color: var(--text2ndary);
}

.btn-flat:hover {
    color: var(--text);
}
</style>
{% endblock %}