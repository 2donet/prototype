<!-- problems/templates/problems/edit_problem.html -->
{% extends "base.html" %}
{% load static %}
{% load comment_tags %}

{% block title %}Edit Problem: {{ problem.name }} | 2do.net{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row">
        <div class="col s12">
            <a href="{% url 'problems:detail' problem.id %}" class="btn-flat waves-effect">
                <i class="material-icons left">arrow_back</i>Back to Problem
            </a>
            <h4>Edit Problem</h4>
            <p class="grey-text">
                Editing problem: <strong>{{ problem.name }}</strong>
            </p>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Problem Details</span>
                    
                    <form method="post" id="edit-problem-form">
                        {% csrf_token %}
                        
                        <!-- Problem Name -->
                        <div class="input-field">
                            <input type="text" name="name" id="problem-name" class="validate" 
                                   value="{{ problem.name }}" required maxlength="200">
                            <label for="problem-name">Problem Title *</label>
                        </div>
                        
                        <!-- Summary -->
                        <div class="input-field">
                            <textarea name="summary" id="problem-summary" class="materialize-textarea" 
                                      maxlength="500">{{ problem.summary|default:'' }}</textarea>
                            <label for="problem-summary">Brief Summary</label>
                        </div>
                        
                        <!-- Description -->
                        <div class="input-field">
                            <textarea name="desc" id="problem-desc" class="materialize-textarea" 
                                      required>{{ problem.desc }}</textarea>
                            <label for="problem-desc">Detailed Description *</label>
                        </div>
                        
                        <!-- Priority and Status Row -->
                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <select name="priority" id="problem-priority">
                                        {% for value, label in priority_choices %}
                                        <option value="{{ value }}" {% if problem.priority == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <label>Priority *</label>
                                </div>
                            </div>
                            
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <select name="status" id="problem-status">
                                        {% for value, label in status_choices %}
                                        <option value="{{ value }}" {% if problem.status == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <label>Status</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Visibility -->
                        <div class="input-field">
                            <select name="visibility" id="problem-visibility">
                                {% for value, label in visibility_choices %}
                                <option value="{{ value }}" {% if problem.visibility == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                            <label>Visibility</label>
                        </div>
                        
                        <!-- Due Date -->
                        <div class="input-field">
                            <h6>Due Date (Optional)</h6>
                            <input type="datetime-local" name="due_date" id="problem-due-date" 
                                   value="{% if problem.due_date %}{{ problem.due_date|date:'Y-m-d\TH:i' }}{% endif %}">
                        </div>
                        
                        <!-- Resolution (only if solved) -->
                        {% if problem.status == 'solved' %}
                        <div class="input-field">
                            <textarea name="resolution" id="problem-resolution" class="materialize-textarea">{{ problem.resolution|default:'' }}</textarea>
                            <label for="problem-resolution">Resolution</label>
                            <span class="helper-text">Describe how this problem was resolved</span>
                        </div>
                        {% endif %}
                        
                        <!-- Skills -->
                        <div class="col s12">
                            <label>Related Skills</label>
                            <div class="chips chips-autocomplete" id="skills-input"></div>
                            <span class="helper-text">Add skills related to this problem. Type and press Enter to add.</span>
                        </div>
                        
                        <!-- Assignment Section -->
                        <div class="section">
                            <h6>Assignment</h6>
                            <p class="grey-text">Click on project members to assign/unassign them to this problem</p>
                            
                            <div id="project-members-container">
                                <div id="project-members-loading" class="center-align">
                                    <div class="preloader-wrapper small active">
                                        <div class="spinner-layer spinner-blue">
                                            <div class="circle-clipper left">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="gap-patch">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="circle-clipper right">
                                                <div class="circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <p>Loading project members...</p>
                                </div>
                                <div id="project-members-list" style="display: none;"></div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Form Actions -->
                <div class="card-action">
                    <button type="submit" form="edit-problem-form" class="btn blue waves-effect waves-light">
                        <i class="material-icons left">save</i>Save Changes
                    </button>
                    
                    <a href="{% url 'problems:detail' problem.id %}" class="btn-flat waves-effect waves-light">
                        Cancel
                    </a>
                    
                    {% if problem.status != 'solved' %}
                    <a href="#!" class="btn green waves-effect waves-light right mark-solved-btn">
                        <i class="material-icons left">check</i>Mark as Solved
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing components...');
    
    // Initialize Materialize components
    M.FormSelect.init(document.querySelectorAll('select'));
    
    // Initialize textarea auto-resize for each textarea individually
    document.querySelectorAll('.materialize-textarea').forEach(function(textarea) {
        M.textareaAutoResize(textarea);
    });
    
    M.CharacterCounter.init(document.querySelectorAll('input[maxlength], textarea[maxlength]'));
    
    // Initialize skills chips with a small delay to ensure DOM is fully ready
    setTimeout(function() {
        initializeSkillsChips();
    }, 100);
    
    // Assignment functionality
    let assignedUsers = new Set();
    let projectMembers = [];
    
    // Get currently assigned users
    const currentlyAssigned = [
        {% for user in problem.assigned_to.all %}
            {{ user.id }},
        {% endfor %}
    ];
    
    // Initialize assigned users set
    currentlyAssigned.forEach(id => assignedUsers.add(id));
    
    // Load project members on page load
    loadProjectMembers();
    
    function loadProjectMembers() {
        const projectId = {% if problem.to_project %}{{ problem.to_project.id }}{% elif problem.to_task.to_project %}{{ problem.to_task.to_project.id }}{% elif problem.to_need.to_project %}{{ problem.to_need.to_project.id }}{% else %}null{% endif %};
        
        if (!projectId) {
            document.getElementById('project-members-loading').innerHTML = '<p class="grey-text">No project context available</p>';
            return;
        }
        
        fetch(`/api/problems/users/project-members/?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                projectMembers = data.results;
                displayProjectMembers();
            } else {
                document.getElementById('project-members-loading').innerHTML = '<p class="grey-text">No project members found</p>';
            }
        })
        .catch(error => {
            console.error('Error loading project members:', error);
            document.getElementById('project-members-loading').innerHTML = '<p class="red-text">Error loading project members</p>';
        });
    }
    
    function displayProjectMembers() {
        const container = document.getElementById('project-members-list');
        const loading = document.getElementById('project-members-loading');
        
        if (projectMembers.length === 0) {
            loading.innerHTML = '<p class="grey-text">No project members found</p>';
            return;
        }
        
        container.innerHTML = projectMembers.map(member => {
            const isAssigned = assignedUsers.has(member.id);
            return `
                <div class="member-chip ${isAssigned ? 'assigned' : ''}" data-user-id="${member.id}" onclick="toggleAssignment(${member.id})">
                    <img src="${member.avatar_url}" alt="${member.username}" class="member-avatar">
                    <span class="member-name">${member.full_name}</span>
                </div>
            `;
        }).join('');
        
        loading.style.display = 'none';
        container.style.display = 'block';
    }
    
    window.toggleAssignment = function(userId) {
        const chip = document.querySelector(`.member-chip[data-user-id="${userId}"]`);
        const wasAssigned = assignedUsers.has(userId);
        
        if (wasAssigned) {
            // Unassign via API
            fetch(`{% url 'problems:unassign_user' problem.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `user_id=${userId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    assignedUsers.delete(userId);
                    chip.classList.remove('assigned');
                    M.toast({html: data.message, classes: 'green'});
                } else {
                    M.toast({html: 'Error: ' + data.error, classes: 'red'});
                }
            })
            .catch(error => {
                console.error('Error:', error);
                M.toast({html: 'Error unassigning user', classes: 'red'});
            });
        } else {
            // Assign via API
            fetch(`{% url 'problems:assign_user' problem.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `user_id=${userId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    assignedUsers.add(userId);
                    chip.classList.add('assigned');
                    M.toast({html: data.message, classes: 'green'});
                } else {
                    M.toast({html: 'Error: ' + data.error, classes: 'red'});
                }
            })
            .catch(error => {
                console.error('Error:', error);
                M.toast({html: 'Error assigning user', classes: 'red'});
            });
        }
    };
    
    // Handle status change to show/hide resolution field
    document.getElementById('problem-status').addEventListener('change', function() {
        const resolutionField = document.getElementById('problem-resolution');
        if (this.value === 'solved' && !resolutionField) {
            // Add resolution field dynamically
            const fieldHtml = `
                <div class="input-field" id="resolution-field">
                    <textarea name="resolution" id="problem-resolution" class="materialize-textarea"></textarea>
                    <label for="problem-resolution">Resolution</label>
                    <span class="helper-text">Describe how this problem was resolved</span>
                </div>
            `;
            document.getElementById('problem-visibility').closest('.input-field').insertAdjacentHTML('afterend', fieldHtml);
            M.textareaAutoResize(document.querySelectorAll('.materialize-textarea'));
        } else if (this.value !== 'solved' && resolutionField) {
            document.getElementById('resolution-field').remove();
        }
    });
    
    // Handle mark as solved button
    const markSolvedBtn = document.querySelector('.mark-solved-btn');
    if (markSolvedBtn) {
        markSolvedBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Change status to solved
            document.getElementById('problem-status').value = 'solved';
            M.FormSelect.init(document.querySelectorAll('select'));
            
            // Trigger change event to show resolution field
            document.getElementById('problem-status').dispatchEvent(new Event('change'));
            
            M.toast({html: 'Status changed to Solved. Please add resolution details.', classes: 'blue'});
        });
    }
    
    // Form submission
    document.getElementById('edit-problem-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get skills data and add as hidden inputs
        const skillsElement = document.getElementById('skills-input');
        const skillsInstance = M.Chips.getInstance(skillsElement);
        
        let skillsData = [];
        if (skillsInstance && skillsInstance.chipsData) {
            skillsData = skillsInstance.chipsData.map(chip => chip.tag);
            console.log('Submitting with skills:', skillsData);
        } else {
            console.warn('Skills chips instance not found or has no data');
        }
        
        // Remove any existing skills hidden inputs
        const existingSkillInputs = this.querySelectorAll('input[name="skills[]"]');
        existingSkillInputs.forEach(input => input.remove());
        
        // Add hidden inputs for skills
        skillsData.forEach(skill => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'skills[]';
            input.value = skill;
            this.appendChild(input);
        });
        
        // Find submit button (it's outside the form but linked via form attribute)
        const submitBtn = document.querySelector('button[form="edit-problem-form"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Saving...';
            submitBtn.disabled = true;
        }
        
        fetch(this.action || window.location.href, {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(html => {
            if (html) {
                // If we got HTML back, there were form errors
                document.body.innerHTML = html;
                // Reinitialize components after replacing content
                setTimeout(function() {
                    M.FormSelect.init(document.querySelectorAll('select'));
                    document.querySelectorAll('.materialize-textarea').forEach(function(textarea) {
                        M.textareaAutoResize(textarea);
                    });
                    initializeSkillsChips();
                }, 100);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            M.toast({html: 'Error saving changes', classes: 'red'});
        })
        .finally(() => {
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="material-icons left">save</i>Save Changes';
                submitBtn.disabled = false;
            }
        });
    });
});

function initializeSkillsChips() {
    const skillsElement = document.getElementById('skills-input');
    
    // Check if element exists and hasn't been initialized already
    if (!skillsElement) {
        console.warn('Skills input element not found');
        return;
    }
    
    // Prevent double initialization
    const existingInstance = M.Chips.getInstance(skillsElement);
    if (existingInstance) {
        console.log('Skills chips already initialized, destroying first');
        existingInstance.destroy();
    }
    
    // Get existing skills from template
    const existingSkills = [
        {% if problem.skills.all %}
            {% for skill in problem.skills.all %}
                {tag: '{{ skill.name }}'},
            {% endfor %}
        {% endif %}
    ];
    
    console.log('Initializing skills chips with existing skills:', existingSkills);
    
    // Fetch skills for autocomplete
    fetch('/n/api/skills/autocomplete/')
        .then(response => response.json())
        .then(data => {
            const autocompleteData = {};
            if (data.success && data.skills) {
                data.skills.forEach(skill => {
                    autocompleteData[skill.name] = null;
                });
            }

            // Initialize chips with autocomplete
            const chipsInstance = M.Chips.init(skillsElement, {
                data: existingSkills,
                placeholder: 'Add skills...',
                secondaryPlaceholder: 'Enter skill name',
                autocompleteOptions: {
                    data: autocompleteData,
                    limit: 10,
                    minLength: 1
                }
            });
            
            console.log('Skills chips initialized successfully with autocomplete');
        })
        .catch(error => {
            console.warn('Could not load skills autocomplete, initializing without:', error);
            
            // Initialize without autocomplete as fallback
            const chipsInstance = M.Chips.init(skillsElement, {
                data: existingSkills,
                placeholder: 'Add skills...',
                secondaryPlaceholder: 'Enter skill name'
            });
            
            console.log('Skills chips initialized successfully without autocomplete');
        });
}
</script>

<style>
/* Color scheme application */
.chips {
    border-bottom: 1px solid var(--highlightmenu);
    min-height: 45px;
}

.chips .chip {
    background-color: var(--bg-color2);
    color: var(--text);
    border: 1px solid var(--highlightmenu);
}

.chips .chip .close {
    color: var(--text2ndary);
}

.chips .chip .close:hover {
    color: var(--danger);
}

.chips input {
    color: var(--text) !important;
}

.helper-text {
    color: var(--text2ndary) !important;
}

/* Member chip styling */
#project-members-list {
    margin-top: 15px;
}

.member-chip {
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
    margin: 4px;
    background-color: var(--bg-color2);
    border: 2px solid var(--highlightmenu);
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text);
}

.member-chip:hover {
    background-color: var(--bg-color3);
    border-color: var(--highlight);
}

.member-chip.assigned {
    background-color: var(--confirm);
    border-color: var(--confirm);
    color: var(--bg-color);
}

.member-chip.assigned:hover {
    background-color: var(--confirm);
    opacity: 0.9;
}

.member-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
}

.member-name {
    font-size: 0.9rem;
    font-weight: 500;
}

/* Loading spinner */
.spinner-layer.spinner-blue {
    border-color: var(--information);
}

/* Card styling */
.card {
    background-color: var(--bg-color2);
    color: var(--text);
}

.card-title {
    color: var(--text) !important;
}

/* Form styling */
.input-field input:focus + label,
.input-field textarea:focus + label {
    color: var(--highlight) !important;
}

.input-field input:focus,
.input-field textarea:focus {
    border-bottom: 1px solid var(--highlight) !important;
    box-shadow: 0 1px 0 0 var(--highlight) !important;
}

select.browser-default:focus {
    outline-color: var(--highlight);
}

/* Button styling */
.btn {
    background-color: var(--information);
}

.btn:hover {
    background-color: var(--highlight);
    color: var(--bg-color);
}

.btn-flat {
    color: var(--text2ndary);
}

.btn-flat:hover {
    color: var(--text);
}

.btn.green {
    background-color: var(--confirm);
}

.btn.green:hover {
    background-color: var(--confirm);
    opacity: 0.9;
}
.member-chip.assigned .member-name {
    color: black;
}
</style>
{% endblock %}